<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrador Financiero - Modo Detallado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .header-bg { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 25px 0; margin-bottom: 25px; position: relative;}
        .card-custom { border: none; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); margin-bottom: 20px; transition: transform 0.2s; }
        .card-custom:hover { transform: translateY(-3px); }
        .file-upload-btn { position: absolute; top: 25px; right: 25px; background: rgba(255,255,255,0.15); padding: 8px 15px; border-radius: 8px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); }
        .money-display { font-size: 1.6rem; font-weight: 800; letter-spacing: -0.5px; }
        .table-hover tbody tr:hover { background-color: #f8f9fa; }
        .badge-plazo { font-size: 0.8em; padding: 5px 8px; }
    </style>
</head>
<body>

    <div class="header-bg text-center">
        <h1><i class="fas fa-chart-line"></i> Finanzas Personales Pro</h1>
        <p class="opacity-75">Visualizador Inteligente de Excel</p>
        
        <div class="file-upload-btn">
            <label class="form-label text-white mb-1" style="cursor: pointer;">
                <i class="fas fa-cloud-upload-alt"></i> Cargar 'Organizador_Deudas_Automatico.xlsx'
                <input type="file" id="excelInput" style="display: none;" accept=".xlsx, .xls">
            </label>
        </div>
    </div>

    <div class="container">
        
        <ul class="nav nav-pills mb-4 justify-content-center" id="myTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dashboard">üìä Resumen General</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#cards">üí≥ Detalles de Tarjetas</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#loans">ü§ù Pr√©stamos y N√≥mina</button></li>
        </ul>

        <div class="tab-content">
            
            <div class="tab-pane fade show active" id="dashboard">
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card card-custom p-4 border-start border-5 border-danger">
                            <h6 class="text-secondary text-uppercase small fw-bold">Deuda en Tarjetas</h6>
                            <div class="money-display text-danger" id="total-debt-cards">$0.00</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-custom p-4 border-start border-5 border-success">
                            <h6 class="text-secondary text-uppercase small fw-bold">Cr√©dito Disponible</h6>
                            <div class="money-display text-success" id="total-available">$0.00</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-custom p-4 border-start border-5 border-warning">
                            <h6 class="text-secondary text-uppercase small fw-bold">Deuda Pr√©stamos</h6>
                            <div class="money-display text-warning" id="total-debt-loans">$0.00</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-custom p-4 border-start border-5 border-primary">
                            <h6 class="text-secondary text-uppercase small fw-bold">Liquidez Real</h6>
                            <div class="money-display text-primary" id="total-cash">$0.00</div>
                            <small class="text-muted" style="font-size: 0.7em;">(Ingresos - Pr√©stamos Personales)</small>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <div class="card card-custom p-4">
                            <h5 class="mb-4">Estado de Deuda vs L√≠mite</h5>
                            <canvas id="debtChart" height="180"></canvas>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-custom p-4 h-100">
                            <h5 class="mb-3">Top Deudas</h5>
                            <div class="table-responsive">
                                <table class="table table-sm align-middle">
                                    <tbody id="summary-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="cards">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card card-custom p-3 bg-white">
                            <label class="form-label fw-bold">Seleccionar Tarjeta a Visualizar:</label>
                            <select class="form-select form-select-lg mb-4 shadow-sm" id="card-selector"></select>

                            <hr>
                            <h6 class="text-primary"><i class="fas fa-plus"></i> Agregar Compra Manual</h6>
                            <p class="small text-muted">Las compras del Excel se cargan autom√°ticamente. Usa esto para simular nuevas.</p>
                            <form id="add-purchase-form">
                                <div class="mb-2"><input type="text" class="form-control" id="purchase-desc" placeholder="Concepto (ej. Cena)" required></div>
                                <div class="row g-2 mb-2">
                                    <div class="col-6"><input type="number" step="0.01" class="form-control" id="purchase-amount" placeholder="$ Monto" required></div>
                                    <div class="col-6">
                                        <select class="form-select" id="purchase-months">
                                            <option value="1">1 Mes</option>
                                            <option value="3">3 Meses</option>
                                            <option value="6">6 Meses</option>
                                            <option value="9">9 Meses</option>
                                            <option value="12">12 Meses</option>
                                            <option value="18">18 Meses</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 btn-sm">Agregar Simulaci√≥n</button>
                            </form>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card card-custom p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h3 id="detail-card-name" class="m-0 text-primary fw-bold">...</h3>
                                <span class="badge bg-secondary fs-6" id="detail-card-limit">L√≠mite: $0</span>
                            </div>
                            
                            <div class="progress mb-2" style="height: 25px;">
                                <div id="detail-progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="d-flex justify-content-between small text-muted mb-4 fw-bold">
                                <span id="detail-used">Usado: $0</span>
                                <span id="detail-available">Disp: $0</span>
                            </div>

                            <h5 class="border-bottom pb-2">üìã Movimientos (Le√≠dos del Excel)</h5>
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-hover table-sm">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>Concepto</th>
                                            <th class="text-center">Progreso</th>
                                            <th class="text-end">Monto Orig.</th>
                                            <th class="text-end text-danger">Saldo Restante</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactions-body">
                                        <tr><td colspan="4" class="text-center text-muted py-3">Carga tu Excel para ver los datos.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="loans">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card card-custom p-4">
                            <h5 class="text-danger mb-3">Deudas Personales</h5>
                            <table class="table table-striped">
                                <thead><tr><th>Persona</th><th>Pagado</th><th>Deuda Actual</th></tr></thead>
                                <tbody id="loans-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card card-custom p-4">
                            <h5 class="text-success mb-3">Ingresos / N√≥mina</h5>
                            <table class="table table-striped">
                                <thead><tr><th>Concepto</th><th class="text-end">Monto</th></tr></thead>
                                <tbody id="income-table-body"></tbody>
                            </table>
                            <div class="mt-3 text-end">
                                <button onclick="resetData()" class="btn btn-outline-danger btn-sm">Borrar Datos</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- ESTADO DE LA APP ---
        const defaultData = { cards: [], loans: [], income: [] };
        let appData = JSON.parse(JSON.stringify(defaultData));
        let myChart = null;

        // --- 1. LECTURA AVANZADA DEL EXCEL ---
        document.getElementById('excelInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});

                // A. LEER RESUMEN (Para obtener l√≠mites y nombres de tarjetas)
                if(workbook.Sheets['Resumen']) {
                    parseResumen(workbook.Sheets['Resumen']);
                    
                    // B. LEER DETALLE DE CADA TARJETA
                    appData.cards.forEach(card => {
                        if(workbook.Sheets[card.name]) {
                            parseCardDetail(card, workbook.Sheets[card.name]);
                        }
                    });

                    alert("¬°Excel procesado! Se han importado todas las compras de cada tarjeta.");
                    saveData();
                    updateUI();
                } else {
                    alert("Error: El Excel no tiene la hoja 'Resumen'.");
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function parseResumen(sheet) {
            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});
            appData.cards = []; appData.loans = []; appData.income = [];
            let section = 'CARDS';

            for(let i=1; i < rows.length; i++) {
                const row = rows[i];
                if(!row || row.length === 0) continue;
                const c0 = (row[0]||"").toString();

                if(c0.includes("TOTAL GENERAL TARJETAS")) { section = 'WAIT'; continue; }
                if(c0.includes("OTRAS CUENTAS")) { section = 'LOANS'; i++; continue; }
                if(c0.includes("RESUMEN DE INGRESOS")) { section = 'INCOME'; i++; continue; }
                if(c0.includes("TOTAL INGRESOS")) { section = 'DONE'; break; }

                if(section === 'CARDS' && typeof row[1] === 'number') {
                    appData.cards.push({ name: row[0], limit: row[1], transactions: [] });
                }
                else if(section === 'LOANS' && typeof row[1] === 'number') {
                    appData.loans.push({ name: row[0], original: row[1], paid: row[2]||0 });
                }
                else if(section === 'INCOME' && typeof row[1] === 'number') {
                    if(!c0.includes("Saldo a Recibir") && !c0.includes("TOTAL")) {
                        appData.income.push({ name: row[0], amount: row[1] });
                    }
                }
            }
        }

        function parseCardDetail(card, sheet) {
            // Seg√∫n tu captura, los datos empiezan en la fila 5 (√≠ndice 4)
            // Columnas: A(0)=Nombre, B(1)=Monto, C(2)=Plazos, D(3)=PagosRealizados
            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, range: 4}); 
            
            rows.forEach(row => {
                // Verificamos que tenga descripci√≥n y monto
                if(row[0] && typeof row[1] === 'number') {
                    card.transactions.push({
                        desc: row[0],
                        amount: row[1],          // Monto Original
                        months: row[2] || 1,     // Plazos
                        paidCycles: row[3] || 0  // Pagos ya hechos
                    });
                }
            });
        }

        // --- 2. C√ÅLCULOS ---
        function calculateCard(card) {
            let currentDebt = 0;
            
            card.transactions.forEach(t => {
                // C√°lculo de deuda real: Monto Original - ( (Monto/Plazos) * PagosHechos )
                let monthlyPayment = t.amount / (t.months || 1);
                let amountPaid = monthlyPayment * (t.paidCycles || 0);
                let balance = t.amount - amountPaid;
                
                // Si por redondeo sale negativo muy peque√±o, poner 0
                if(balance < 0) balance = 0;
                currentDebt += balance;
            });

            // Si no hay transacciones pero el excel ten√≠a una "Deuda Inicial" manual (legacy), podr√≠amos sumarla, 
            // pero tu captura muestra todo desglosado. Asumiremos que la suma de transacciones es la deuda.
            return { debt: currentDebt, available: card.limit - currentDebt };
        }

        function formatMoney(n) { 
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(n||0); 
        }

        // --- 3. UI ---
        function updateUI() {
            if(appData.cards.length === 0) return;

            let totalDebt = 0, totalLimit = 0;
            const summaryBody = document.getElementById('summary-table-body');
            summaryBody.innerHTML = '';

            // Llenar datos de tarjetas
            appData.cards.forEach((c, idx) => {
                const stats = calculateCard(c);
                totalDebt += stats.debt;
                totalLimit += c.limit;

                // Fila en tabla resumen
                const pct = c.limit > 0 ? (stats.debt/c.limit)*100 : 0;
                summaryBody.innerHTML += `
                    <tr>
                        <td><strong>${c.name}</strong></td>
                        <td class="text-end ${pct>90?'text-danger':''}">${formatMoney(stats.debt)}</td>
                        <td class="text-end text-muted small">${pct.toFixed(0)}%</td>
                    </tr>`;
            });

            // Llenar Pr√©stamos
            let totalLoans = 0;
            const loansBody = document.getElementById('loans-table-body');
            loansBody.innerHTML = '';
            appData.loans.forEach(l => {
                let debt = l.original - l.paid;
                totalLoans += debt;
                loansBody.innerHTML += `<tr><td>${l.name}</td><td>${formatMoney(l.paid)}</td><td class="fw-bold text-danger">${formatMoney(debt)}</td></tr>`;
            });

            // Llenar Ingresos
            let totalIncome = 0;
            const incomeBody = document.getElementById('income-table-body');
            incomeBody.innerHTML = '';
            appData.income.forEach(i => {
                totalIncome += i.amount;
                incomeBody.innerHTML += `<tr><td>${i.name}</td><td class="text-end fw-bold text-success">${formatMoney(i.amount)}</td></tr>`;
            });

            // Totales Superiores
            document.getElementById('total-debt-cards').innerText = formatMoney(totalDebt);
            document.getElementById('total-available').innerText = formatMoney(totalLimit - totalDebt);
            document.getElementById('total-debt-loans').innerText = formatMoney(totalLoans);
            document.getElementById('total-cash').innerText = formatMoney(totalIncome - totalLoans);

            // Actualizar Gr√°fica y Selector
            updateChart();
            updateSelector();
        }

        function renderCardDetail(idx) {
            const card = appData.cards[idx];
            if(!card) return;

            const stats = calculateCard(card);
            const pct = card.limit > 0 ? (stats.debt / card.limit)*100 : 0;

            document.getElementById('detail-card-name').innerText = card.name;
            document.getElementById('detail-card-limit').innerText = `L√≠mite: ${formatMoney(card.limit)}`;
            document.getElementById('detail-used').innerText = `Usado: ${formatMoney(stats.debt)}`;
            document.getElementById('detail-available').innerText = `Disp: ${formatMoney(stats.available)}`;

            const bar = document.getElementById('detail-progress');
            bar.style.width = `${pct}%`;
            bar.className = `progress-bar progress-bar-striped progress-bar-animated ${pct>85 ? 'bg-danger' : (pct>50?'bg-warning':'bg-success')}`;

            // Tabla de Transacciones
            const tbody = document.getElementById('transactions-body');
            tbody.innerHTML = '';
            
            if(card.transactions.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-3">No hay compras registradas en esta tarjeta.</td></tr>`;
            } else {
                card.transactions.forEach(t => {
                    let monthly = t.amount / (t.months || 1);
                    let paid = monthly * (t.paidCycles || 0);
                    let remaining = t.amount - paid;
                    if(remaining < 0) remaining = 0;

                    // Barra peque√±a de progreso del pago
                    let payPct = (t.paidCycles / t.months) * 100;
                    if(t.months === 1) payPct = t.paidCycles > 0 ? 100 : 0;

                    tbody.innerHTML += `
                        <tr>
                            <td>
                                <div class="fw-bold">${t.desc}</div>
                                <div class="small text-muted">${t.months} Meses (${formatMoney(monthly)}/mes)</div>
                            </td>
                            <td class="align-middle text-center" style="width: 20%;">
                                <div class="small text-muted mb-1">${t.paidCycles}/${t.months} pagos</div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-success" style="width: ${payPct}%"></div>
                                </div>
                            </td>
                            <td class="align-middle text-end text-muted small">${formatMoney(t.amount)}</td>
                            <td class="align-middle text-end fw-bold text-dark">${formatMoney(remaining)}</td>
                        </tr>
                    `;
                });
            }
        }

        function updateSelector() {
            const sel = document.getElementById('card-selector');
            const currentVal = sel.value;
            sel.innerHTML = '';
            appData.cards.forEach((c, i) => {
                let opt = document.createElement('option');
                opt.value = i;
                opt.text = c.name;
                sel.add(opt);
            });
            if(currentVal && appData.cards[currentVal]) sel.value = currentVal;
            renderCardDetail(sel.value || 0);
        }

        // Agregar Compra Manual (Simulaci√≥n)
        document.getElementById('add-purchase-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const idx = document.getElementById('card-selector').value;
            appData.cards[idx].transactions.push({
                desc: document.getElementById('purchase-desc').value,
                amount: parseFloat(document.getElementById('purchase-amount').value),
                months: parseInt(document.getElementById('purchase-months').value),
                paidCycles: 0 // Nueva compra, 0 pagos
            });
            saveData();
            updateUI();
            document.getElementById('purchase-desc').value = '';
            document.getElementById('purchase-amount').value = '';
        });

        document.getElementById('card-selector').addEventListener('change', (e) => renderCardDetail(e.target.value));

        // Gr√°fica
        function updateChart() {
            const ctx = document.getElementById('debtChart').getContext('2d');
            const names = appData.cards.map(c => c.name);
            const debts = appData.cards.map(c => calculateCard(c).debt);
            const limits = appData.cards.map(c => c.limit);

            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: names,
                    datasets: [
                        { label: 'Deuda Real', data: debts, backgroundColor: '#dc3545', borderRadius: 4 },
                        { label: 'L√≠mite', data: limits, type: 'line', borderColor: '#198754', borderWidth: 2, pointRadius: 0 }
                    ]
                },
                options: { responsive: true, plugins: { legend: {position:'bottom'} } }
            });
        }

        // Persistencia
        function loadData() { const s = localStorage.getItem('finanzasV3'); if(s) appData = JSON.parse(s); }
        function saveData() { localStorage.setItem('finanzasV3', JSON.stringify(appData)); }
        function resetData() { if(confirm("¬øBorrar todo?")) { localStorage.removeItem('finanzasV3'); location.reload(); } }

        // Init
        loadData();
        updateUI();

    </script>
</body>
</html>